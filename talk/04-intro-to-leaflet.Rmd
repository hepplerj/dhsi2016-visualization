---
title       : "Introduction to Leaflet"
author      : Jason A. Heppler
maketitle: true
output:
  rmdshower::shower_presentation:
    self_contained: false
    katex: true
    theme: material
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message = F, warning = F, echo =F}
library(leaflet)
library(RColorBrewer)
library(rgdal)
library(raster)
library(ggplot2)
library(ggmap)
library(magrittr)
```

## Leaflet

Leaflet is a popular open-source JavaScript library for creating interactive maps, used by a range of sites including the *New York Times*, the *Washington Post*, GitHub, Flickr, OpenStreetMap, Mapbox, and CartoDB.

This package makes using Leaflet in R simple.

## Leaflet

Leaflet features include:

- Interactive panning/zooming
- Compose maps using:
    - Map tiles
    - Markers
    - Polygons
    - Lines
    - Popups
    - GeoJSON
  
## Leaflet

Leaflet features include:

- Create maps from the R console or RStudio
- Embed maps in RMarkdown documents and Shiny apps
- Easily render spatial objects from the `sp` package, or data frames with latitude/longitude columns
- Use map bounds and mouse events to drive Shiny app logic

## Leaflet

```{r eval = F}
install.packages("leaflet")
# or the dev version
# devtools::install_github("rstudio/leaflet")
```

## Leaflet

Let's recall our process for building maps in `ggplot`.

```{r}
library(ggplot2)
library(ggmap)
map <- ggplot() + 
           geom_point(data=superfund_sites, 
                      aes(x=longitude, y=latitude))
```

## {.fullscreen}

```{r, echo=F, message=F, warning=F}
map
```

## Leaflet

```{r}
basemap <- get_map(location = "United States",
                      zoom=4,
                      maptype = "terrain",
                      source="google",
                      color="bw")
```

## Leaflet

```{r}
map <- ggmap(basemap) + 
      geom_point(data=superfund_sites, aes(x=longitude, y=latitude), 
                 size = 0.5, alpha = 0.4, color = "#e34a33")
```

## {.fullscreen}

```{r, echo=F, warning=F,message=F}
map
```

## Leaflet

Leaflet maps are easily initiated by invoking `leaflet()`.

```{r, fig.height=4}
library(leaflet)
leaflet() %>% addTiles() %>% 
  addMarkers(lng = -123.3656, lat = 48.4284)
```

## Leaflet - Superfund Map

Let's try mapping the first thirty Superfund sites in the dataset. 

```{r, eval = T}
superfund_leaflet <- leaflet() %>% addTiles() %>%
      addCircleMarkers(data = superfund_sites[1:30,])
```

## {.fullscreen}

```{r, echo = F}
superfund_leaflet
```

## Leaflet - Popups

```{r}
leaflet() %>% addTiles() %>%
      addCircleMarkers(data=superfund_sites[1:20,],
                       stroke = FALSE, fillOpacity = 0.5, radius=8,
                       popup=~paste("<strong>Site:</strong>", site.name,
                       "<br>",
                       "<strong>Date Added:</strong>", date,
                       "<br>",
                       "<strong>County:</strong>", county))
```

## Leaflet

Let's look at another dataset.

```{r, eval=F}
peaks <- readOGR("./data/peaks.geojson", "OGRGeoJSON", verbose=FALSE)
# Yosemite boundary shapefile
yosemite <- readOGR("./data/yosemite", "yosemite", verbose = FALSE)
```

## Yosemite

```{r, echo = F}
leaflet() %>% addTiles() %>% 
  addPolylines(data = yosemite)
```

## Leaflet

```{r, eval = FALSE}
# Convert peak values to numeric
peaks <- subset(peaks, peaks@data$ele != "0")
peaks@data$ele <- round(as.numeric(levels(peaks@data$ele))[peaks@data$ele] * 3.28084)

# Make map of peaks
leaflet() %>%
  addTiles() %>%
  addCircleMarkers(data=peaks, weight=0, radius=8, fillOpacity=0.6,
                   popup=~paste("Name: ", name, "<br>Elevation: ", ele, "feet")) %>%
  addPolylines(data=yosemite, fillOpacity = 0, dashArray=c(10,10), fill=FALSE, color="red")
```

## {.fullscreen}

```{r, echo=FALSE}
# Convert peak values to numeric
peaks <- subset(peaks, peaks@data$ele != "0")
peaks@data$ele <- round(as.numeric(levels(peaks@data$ele))[peaks@data$ele] * 3.28084)

# Make map of peaks
leaflet() %>%
  addTiles() %>%
  addCircleMarkers(data=peaks, weight=0, radius=8, fillOpacity=0.6,
                   popup=~paste("Name: ", name, "<br>Elevation: ", ele, "feet")) %>%
  addPolylines(data=yosemite, fillOpacity = 0, dashArray=c(10,10), fill=FALSE, color="red")
```

## Leaflet

```{r, eval=FALSE}
leaflet() %>%
  addTiles() %>%
  addCircleMarkers(data=peaks, weight=0, radius=~ele/1000, fillOpacity=0.6,
                   popup=~paste("Name: ", name, "<br>Elevation: ", ele, "feet")) %>%
  addPolylines(data=yosemite, fillOpacity = 0, dashArray=c(10,10), fill=FALSE, color="red")
```

## {.fullscreen}

```{r, echo = F}
leaflet() %>%
  addTiles() %>%
  addCircleMarkers(data=peaks, weight=0, radius=~ele/1000, fillOpacity=0.6,
                   popup=~paste("Name: ", name, "<br>Elevation: ", ele, "feet")) %>%
  addPolylines(data=yosemite, fillOpacity = 0, dashArray=c(10,10), fill=FALSE, color="red")
```

## Leaflet - Color and Legends

```{r, eval = F}
# Create the color scale from elevation
# using the ColorBrewer palette
spectral <- brewer.pal(11, "Spectral")  %>% rev()
eleColor <- colorBin(spectral, peaks@data$ele)

leaflet(peaks) %>%
  addTiles() %>%
  addCircleMarkers(weight=0, radius=~ele/1000, fillOpacity=0.7, color = ~eleColor(ele),
                   popup=~paste("Name: ", name, "<br>Elevation: ", ele)) %>%
    addLegend(title = "Peak Elevation", pal = eleColor,
            values = ~ele, opacity = 1, position="bottomleft") %>%
  addPolylines(data=yosemite, fillOpacity = 0, dashArray=c(10,10), fill=FALSE, color="blue")
```

## {.fullscreen}

```{r, echo = F}
# Create the color scale from elevation
# using the ColorBrewer palette
spectral <- brewer.pal(11, "Spectral")  %>% rev()
eleColor <- colorBin(spectral, peaks@data$ele)

leaflet(peaks) %>%
  addTiles() %>%
  addCircleMarkers(weight=0, radius=~ele/1000, fillOpacity=0.7, color = ~eleColor(ele),
                   popup=~paste("Name: ", name, "<br>Elevation: ", ele)) %>%
    addLegend(title = "Peak Elevation", pal = eleColor,
            values = ~ele, opacity = 1, position="bottomleft") %>%
  addPolylines(data=yosemite, fillOpacity = 0, dashArray=c(10,10), fill=FALSE, color="blue")
```

## Leaflet - Basemaps

```{r, eval = F}
leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolylines(data=yosemite, fillOpacity = 0, dashArray=c(10,10), fill=FALSE, color="black")
```

## {.fullscreen}

```{r, echo = F}
leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolylines(data=yosemite, fillOpacity = 0, dashArray=c(10,10), fill=FALSE, color="black")
```

## {.fullscreen}

```{r, echo = F}
leaflet(peaks) %>%
  addProviderTiles("CartoDB.Positron") %>%
  addCircleMarkers(weight=0, radius=~ele/1000, fillOpacity=0.7, color = ~eleColor(ele),
                   popup=~paste("Name: ", name, "<br>Elevation: ", ele)) %>%
    addLegend(title = "Peak Elevation", pal = eleColor,
            values = ~ele, opacity = 1, position="bottomleft") %>%
  addPolylines(data=yosemite, fillOpacity = 0, dashArray=c(10,10), fill=FALSE, color="blue")
```

## Layer Switcher

Assign a **group** to each of the layers for a layer selector to work.

## {.fullscreen}

```{r}
mapbox <- "http://api.tiles.mapbox.com/v4/mapbox.outdoors/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoiam9zaHBlcHBlciIsImEiOiJuTWdrY2k4In0.HCCXtgU04scrTB_-ON4kjA"

leaflet(peaks) %>%
  addCircleMarkers(weight = 0, radius = ~ele/1000, 
                   fillOpacity = 0.7, color = ~eleColor(ele),
                   popup = ~paste("Name: ", name, "<br>Elevation: ", ele),
                   group = "Peaks") %>%
  
  addLegend(title = "Peak Elevation", pal = eleColor,
            values = ~ele, opacity = 1, position="bottomright") %>%
  
  addPolylines(data = yosemite, fillOpacity = 0, 
               dashArray = c(10,10), fill = FALSE, color = "blue",
               group = "Yosemite") %>%
  
  # Add basemaps
  addProviderTiles("CartoDB.Positron", group="Simple") %>%
  addProviderTiles("Esri.WorldImagery", group="Satellite") %>%
  addTiles(urlTemplate = mapbox, group="Outdoors") %>%
  
  # Add layer switcher
   addLayersControl(
    baseGroups = c("Simple", "Satellite", "Outdoors"),
    overlayGroups = c("Peaks","Yosemite"),
    options = layersControlOptions(collapsed = FALSE)
  )
```
